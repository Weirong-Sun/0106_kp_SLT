# åˆ†å¸ƒå¼å…³é”®ç‚¹æå–åˆ†æ

## æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æåˆ†å¸ƒå¼å¤„ç†å¯¹å…³é”®ç‚¹æå–è¾“å‡ºçš„å½±å“ï¼Œä»¥åŠå¦‚ä½•æ­£ç¡®ä½¿ç”¨åˆ†å¸ƒå¼ç‰ˆæœ¬ã€‚

## åˆ†å¸ƒå¼å®ç°æ–¹å¼

### æŠ€æœ¯æ–¹æ¡ˆ

ä½¿ç”¨ Python çš„ `multiprocessing` æ¨¡å—å®ç°å¤šè¿›ç¨‹å¹¶è¡Œå¤„ç†ï¼š

1. **è¿›ç¨‹æ± **: ä½¿ç”¨ `multiprocessing.Pool` ç®¡ç†å¤šä¸ªå·¥ä½œè¿›ç¨‹
2. **æ•°æ®åˆ†å‰²**: å°†å›¾åƒåˆ—è¡¨å‡åŒ€åˆ†å‰²åˆ°ä¸åŒçš„è¿›ç¨‹
3. **ç‹¬ç«‹å®ä¾‹**: æ¯ä¸ªè¿›ç¨‹åˆ›å»ºè‡ªå·±çš„ MediaPipe å®ä¾‹ï¼ˆå› ä¸º MediaPipe ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼‰
4. **ç»“æœåˆå¹¶**: æ”¶é›†æ‰€æœ‰è¿›ç¨‹çš„ç»“æœå¹¶åˆå¹¶

### å…³é”®è®¾è®¡

```python
# æ¯ä¸ªè¿›ç¨‹åˆ›å»ºç‹¬ç«‹çš„ MediaPipe å®ä¾‹
def extract_keypoints_worker(args):
    extractor = FullBodyKeypointExtractor(...)  # æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹åˆ›å»º
    # å¤„ç†åˆ†é…ç»™è¯¥è¿›ç¨‹çš„å›¾åƒ
    return results
```

## å¯¹å…³é”®ç‚¹è¾“å‡ºçš„å½±å“åˆ†æ

### âœ… ä¸ä¼šå½±å“å…³é”®ç‚¹è¾“å‡ºçš„åŸå› 

#### 1. **å¤„ç†ç‹¬ç«‹æ€§**

- **æ¯ä¸ªå›¾åƒçš„å¤„ç†æ˜¯ç‹¬ç«‹çš„**: MediaPipe å¯¹æ¯ä¸ªå›¾åƒçš„å¤„ç†ä¸ä¾èµ–äºå…¶ä»–å›¾åƒ
- **æ— çŠ¶æ€å¤„ç†**: å…³é”®ç‚¹æå–æ˜¯é™æ€å›¾åƒå¤„ç†ï¼Œä¸æ¶‰åŠæ—¶åºä¾èµ–
- **ç¡®å®šæ€§ç®—æ³•**: MediaPipe ä½¿ç”¨ç¡®å®šæ€§ç®—æ³•ï¼Œç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒè¾“å‡º

#### 2. **è¿›ç¨‹éš”ç¦»**

- **ç‹¬ç«‹å†…å­˜ç©ºé—´**: æ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œä¸ä¼šç›¸äº’å¹²æ‰°
- **ç‹¬ç«‹ MediaPipe å®ä¾‹**: æ¯ä¸ªè¿›ç¨‹åˆ›å»ºè‡ªå·±çš„ MediaPipe æ¨¡å‹å®ä¾‹
- **æ— å…±äº«çŠ¶æ€**: è¿›ç¨‹é—´ä¸å…±äº«ä»»ä½•çŠ¶æ€å˜é‡

#### 3. **æ•°æ®å®Œæ•´æ€§**

- **å®Œæ•´å›¾åƒä¼ é€’**: æ¯ä¸ªè¿›ç¨‹æ¥æ”¶å®Œæ•´çš„å›¾åƒè·¯å¾„ï¼Œç‹¬ç«‹åŠ è½½å’Œå¤„ç†
- **ç»“æœå®Œæ•´æ”¶é›†**: æ‰€æœ‰è¿›ç¨‹çš„ç»“æœéƒ½è¢«å®Œæ•´æ”¶é›†å’Œåˆå¹¶
- **é¡ºåºä¿æŒ**: è™½ç„¶å¤„ç†æ˜¯å¹¶è¡Œçš„ï¼Œä½†ç»“æœæŒ‰åŸå§‹é¡ºåºåˆå¹¶

### âš ï¸ éœ€è¦æ³¨æ„çš„äº‹é¡¹

#### 1. **å¤„ç†é¡ºåº**

**é—®é¢˜**: å¹¶è¡Œå¤„ç†å¯èƒ½å¯¼è‡´ç»“æœé¡ºåºä¸è¾“å…¥é¡ºåºä¸å®Œå…¨ä¸€è‡´

**å½±å“**:
- å¦‚æœä¸¥æ ¼æŒ‰ç…§è§†é¢‘é¡ºåºå¤„ç†ï¼Œé¡ºåºå¯èƒ½ç•¥æœ‰ä¸åŒ
- ä½†æ¯ä¸ªå›¾åƒçš„å…³é”®ç‚¹æœ¬èº«æ˜¯æ­£ç¡®çš„

**è§£å†³æ–¹æ¡ˆ**:
- åœ¨ç»“æœä¸­åŒ…å«å›¾åƒè·¯å¾„å’Œè§†é¢‘IDï¼Œå¯ä»¥é€šè¿‡è¿™äº›ä¿¡æ¯é‡æ–°æ’åº
- æˆ–è€…æŒ‰è§†é¢‘åˆ†ç»„å¤„ç†ï¼Œä¿æŒè§†é¢‘å†…é¡ºåº

#### 2. **å†…å­˜ä½¿ç”¨**

**é—®é¢˜**: å¤šä¸ªè¿›ç¨‹åŒæ—¶è¿è¡Œä¼šå¢åŠ å†…å­˜ä½¿ç”¨

**å½±å“**:
- æ¯ä¸ªè¿›ç¨‹éœ€è¦åŠ è½½ MediaPipe æ¨¡å‹ï¼ˆçº¦ 100-200MBï¼‰
- 4ä¸ªè¿›ç¨‹å¯èƒ½éœ€è¦ 400-800MB é¢å¤–å†…å­˜

**è§£å†³æ–¹æ¡ˆ**:
- æ ¹æ®å¯ç”¨å†…å­˜è°ƒæ•´ `num_workers`
- å¦‚æœå†…å­˜ä¸è¶³ï¼Œå‡å°‘å·¥ä½œè¿›ç¨‹æ•°

#### 3. **é”™è¯¯å¤„ç†**

**é—®é¢˜**: æŸä¸ªè¿›ç¨‹å‡ºé”™å¯èƒ½å½±å“æ•´ä½“å¤„ç†

**å½±å“**:
- å•ä¸ªå›¾åƒå¤„ç†å¤±è´¥ä¸ä¼šå½±å“å…¶ä»–å›¾åƒ
- ä½†è¿›ç¨‹å´©æºƒå¯èƒ½å¯¼è‡´éƒ¨åˆ†æ•°æ®ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**:
- ä»£ç ä¸­å·²åŒ…å«å¼‚å¸¸å¤„ç†
- å¤±è´¥çš„å›¾åƒä¼šè¿”å› `None`ï¼Œä¸å½±å“å…¶ä»–å›¾åƒ

## æ€§èƒ½å¯¹æ¯”

### ç†è®ºåŠ é€Ÿæ¯”

å‡è®¾ï¼š
- å•è¿›ç¨‹å¤„ç†é€Ÿåº¦: 1 å›¾åƒ/ç§’
- 4è¿›ç¨‹å¹¶è¡Œå¤„ç†: ç†è®ºä¸Šå¯è¾¾ 4 å›¾åƒ/ç§’

å®é™…åŠ é€Ÿæ¯”å–å†³äºï¼š
- CPU æ ¸å¿ƒæ•°
- å†…å­˜å¸¦å®½
- I/O é€Ÿåº¦ï¼ˆå›¾åƒåŠ è½½ï¼‰
- MediaPipe å¤„ç†æ—¶é—´

### å®é™…æµ‹è¯•å»ºè®®

```bash
# å•è¿›ç¨‹ç‰ˆæœ¬ï¼ˆåŸºå‡†ï¼‰
time python data/extract_phoenix_keypoints.py \
    --dataset_path /path/to/dataset \
    --output_path test_single.pkl \
    --max_samples_per_split 100

# 4è¿›ç¨‹åˆ†å¸ƒå¼ç‰ˆæœ¬
time python data/extract_phoenix_keypoints_distributed.py \
    --dataset_path /path/to/dataset \
    --output_path test_distributed.pkl \
    --max_samples_per_split 100 \
    --num_workers 4
```

## éªŒè¯æ–¹æ³•

### æ–¹æ³• 1: ä½¿ç”¨éªŒè¯è„šæœ¬ï¼ˆæ¨èï¼‰

é¡¹ç›®æä¾›äº†ä¸“é—¨çš„éªŒè¯è„šæœ¬ï¼š

```bash
# éªŒè¯ä¸¤ä¸ªç»“æœæ–‡ä»¶
python verify_distributed_results.py \
    --single result_single.pkl \
    --distributed result_distributed.pkl

# åªéªŒè¯è®­ç»ƒé›†
python verify_distributed_results.py \
    --single result_single.pkl \
    --distributed result_distributed.pkl \
    --splits train
```

éªŒè¯è„šæœ¬ä¼šï¼š
- æ¯”è¾ƒæ ·æœ¬æ•°é‡
- æ¯”è¾ƒæ¯ä¸ªæ ·æœ¬çš„å…³é”®ç‚¹
- æ¯”è¾ƒç»Ÿè®¡ä¿¡æ¯
- æŠ¥å‘Šæ‰€æœ‰å·®å¼‚

### æ–¹æ³• 2: æ‰‹åŠ¨ç»“æœå¯¹æ¯”

```python
import pickle
import numpy as np

# åŠ è½½å•è¿›ç¨‹ç»“æœ
with open('result_single.pkl', 'rb') as f:
    single = pickle.load(f)

# åŠ è½½åˆ†å¸ƒå¼ç»“æœ
with open('result_distributed.pkl', 'rb') as f:
    distributed = pickle.load(f)

# æŒ‰å›¾åƒè·¯å¾„æ’åºï¼ˆç¡®ä¿é¡ºåºä¸€è‡´ï¼‰
def sort_by_path(data, split):
    items = list(zip(
        data[split]['image_paths'],
        data[split]['keypoints'],
        data[split]['video_ids']
    ))
    items.sort(key=lambda x: x[0])
    return items

# æ¯”è¾ƒå…³é”®ç‚¹
single_items = sort_by_path(single, 'train')
distributed_items = sort_by_path(distributed, 'train')

# éªŒè¯æ•°é‡
assert len(single_items) == len(distributed_items)

# éªŒè¯æ¯ä¸ªæ ·æœ¬
for (path1, kp1, vid1), (path2, kp2, vid2) in zip(single_items, distributed_items):
    assert path1 == path2, f"è·¯å¾„ä¸åŒ¹é…: {path1} vs {path2}"
    assert vid1 == vid2, f"è§†é¢‘IDä¸åŒ¹é…: {vid1} vs {vid2}"

    # æ¯”è¾ƒå…³é”®ç‚¹
    for key in ['face', 'left_hand', 'right_hand', 'pose']:
        if kp1[key] is None and kp2[key] is None:
            continue
        if kp1[key] is None or kp2[key] is None:
            print(f"è­¦å‘Š: {path1} çš„ {key} å…³é”®ç‚¹ä¸ä¸€è‡´")
            continue

        if not np.allclose(kp1[key], kp2[key], atol=1e-6):
            print(f"é”™è¯¯: {path1} çš„ {key} å…³é”®ç‚¹ä¸åŒ¹é…")
        else:
            print(f"âœ“ {path1} çš„ {key} å…³é”®ç‚¹åŒ¹é…")

print("æ‰€æœ‰å…³é”®ç‚¹éªŒè¯é€šè¿‡ï¼")
```

### æ–¹æ³• 3: ç»Ÿè®¡å¯¹æ¯”

```python
# æ¯”è¾ƒç»Ÿè®¡ä¿¡æ¯
print("å•è¿›ç¨‹ç»Ÿè®¡:")
print(single['stats'])

print("\nåˆ†å¸ƒå¼ç»Ÿè®¡:")
print(distributed['stats'])

# åº”è¯¥å®Œå…¨ä¸€è‡´
assert single['stats'] == distributed['stats']
```

## å¿«é€ŸéªŒè¯æµç¨‹

### å®Œæ•´éªŒè¯æ­¥éª¤

```bash
# 1. ä½¿ç”¨å•è¿›ç¨‹å¤„ç†å°æ•°æ®é›†ï¼ˆåŸºå‡†ï¼‰
python data/extract_phoenix_keypoints.py \
    --dataset_path /path/to/dataset \
    --output_path result_single.pkl \
    --max_samples_per_split 10

# 2. ä½¿ç”¨åˆ†å¸ƒå¼å¤„ç†ç›¸åŒæ•°æ®é›†
python data/extract_phoenix_keypoints_distributed.py \
    --dataset_path /path/to/dataset \
    --output_path result_distributed.pkl \
    --max_samples_per_split 10 \
    --num_workers 4

# 3. éªŒè¯ç»“æœä¸€è‡´æ€§
python verify_distributed_results.py \
    --single result_single.pkl \
    --distributed result_distributed.pkl

# 4. å¦‚æœéªŒè¯é€šè¿‡ï¼Œå¤„ç†å®Œæ•´æ•°æ®é›†
python data/extract_phoenix_keypoints_distributed.py \
    --dataset_path /path/to/dataset \
    --output_path phoenix_keypoints.pkl \
    --num_workers 4
```

## ä½¿ç”¨å»ºè®®

### 1. å·¥ä½œè¿›ç¨‹æ•°è®¾ç½®

```bash
# 4å—GPUæœåŠ¡å™¨ï¼Œä½¿ç”¨4ä¸ªè¿›ç¨‹
--num_workers 4

# 8æ ¸CPUï¼Œå¯ä»¥ä½¿ç”¨4-8ä¸ªè¿›ç¨‹
--num_workers 4  # ä¿å®ˆ
--num_workers 8  # æ¿€è¿›

# æ ¹æ®CPUæ ¸å¿ƒæ•°è‡ªåŠ¨è°ƒæ•´
--num_workers $(nproc)  # Linux
```

### 2. å†…å­˜è€ƒè™‘

- **æ¯ä¸ªè¿›ç¨‹**: çº¦ 200-300MBï¼ˆMediaPipeæ¨¡å‹ + å›¾åƒç¼“å­˜ï¼‰
- **4ä¸ªè¿›ç¨‹**: çº¦ 800MB-1.2GB
- **å»ºè®®**: ç¡®ä¿æœ‰è¶³å¤Ÿå†…å­˜ï¼Œé¿å…äº¤æ¢ï¼ˆswapï¼‰

### 3. æœ€ä½³å®è·µ

```bash
# 1. å…ˆç”¨å°æ•°æ®é›†æµ‹è¯•ï¼ˆå•è¿›ç¨‹åŸºå‡†ï¼‰
python data/extract_phoenix_keypoints.py \
    --dataset_path /path/to/dataset \
    --output_path test_single.pkl \
    --max_samples_per_split 10

# 2. ä½¿ç”¨åˆ†å¸ƒå¼å¤„ç†ç›¸åŒæ•°æ®é›†
python data/extract_phoenix_keypoints_distributed.py \
    --dataset_path /path/to/dataset \
    --output_path test_distributed.pkl \
    --max_samples_per_split 10 \
    --num_workers 4

# 3. éªŒè¯ç»“æœæ­£ç¡®æ€§
python verify_distributed_results.py \
    --single test_single.pkl \
    --distributed test_distributed.pkl

# 4. å¦‚æœéªŒè¯é€šè¿‡ï¼Œå¤„ç†å®Œæ•´æ•°æ®é›†
python data/extract_phoenix_keypoints_distributed.py \
    --dataset_path /path/to/dataset \
    --output_path phoenix_keypoints.pkl \
    --num_workers 4
```

## ç»“è®º

### âœ… åˆ†å¸ƒå¼å¤„ç†ä¸ä¼šå½±å“å…³é”®ç‚¹è¾“å‡º

**åŸå› æ€»ç»“**:
1. MediaPipe å¤„ç†æ˜¯ç¡®å®šæ€§çš„
2. æ¯ä¸ªå›¾åƒå¤„ç†æ˜¯ç‹¬ç«‹çš„
3. è¿›ç¨‹é—´å®Œå…¨éš”ç¦»
4. ç»“æœå®Œæ•´æ”¶é›†å’Œåˆå¹¶

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¡ºåº**: å¦‚æœéœ€è¦ä¸¥æ ¼é¡ºåºï¼Œå¯ä»¥é€šè¿‡è·¯å¾„é‡æ–°æ’åº
2. **å†…å­˜**: ç¡®ä¿æœ‰è¶³å¤Ÿå†…å­˜æ”¯æŒå¤šè¿›ç¨‹
3. **éªŒè¯**: å»ºè®®å…ˆç”¨å°æ•°æ®é›†éªŒè¯ç»“æœæ­£ç¡®æ€§

### ğŸ“Š æ€§èƒ½æå‡

- **ç†è®ºåŠ é€Ÿ**: 4è¿›ç¨‹ â‰ˆ 3-4å€é€Ÿåº¦æå‡
- **å®é™…åŠ é€Ÿ**: å–å†³äºç¡¬ä»¶å’Œæ•°æ®é›†ç‰¹æ€§
- **å»ºè®®**: æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ `num_workers`

## ç›¸å…³æ–‡æ¡£

- [PHOENIXæ•°æ®é›†å…³é”®ç‚¹æå–æŒ‡å—.md](./PHOENIXæ•°æ®é›†å…³é”®ç‚¹æå–æŒ‡å—.md)
- [é¡¹ç›® README.md](../README.md)

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2024å¹´
**é€‚ç”¨ç‰ˆæœ¬**: extract_phoenix_keypoints_distributed.py

